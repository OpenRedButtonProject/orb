# //third_party/orb/external/libwebsockets/v4.3/BUILD.gn

import("//build/config/compiler/compiler.gni") # For compiler configs
import("//build/config/features.gni")          # For common features like is_debug, is_android etc.

# ==============================================================================
# Public Configuration: For consumers of this library
# ==============================================================================
config("libwebsockets_public_config") {
  # This path allows consumers to include LWS headers like #include "libwebsockets.h"
  include_dirs = [ "source/include" ]
}

# ==============================================================================
# The main libwebsockets static library target
# ==============================================================================
static_library("libwebsockets") {
  sources = [
    # Network
    "source/lib/core-net/adopt.c",
    "source/lib/core-net/client/client.c",
    "source/lib/core-net/client/conmon.c",
    "source/lib/core-net/client/connect.c",
    "source/lib/core-net/client/connect2.c",
    "source/lib/core-net/client/connect3.c",
    "source/lib/core-net/client/connect4.c",
    "source/lib/core-net/client/sort-dns.c",
    "source/lib/core-net/close.c",
    "source/lib/core-net/dummy-callback.c",
    "source/lib/core-net/network.c",
    "source/lib/core-net/output.c",
    "source/lib/core-net/pollfd.c",
    "source/lib/core-net/service.c",
    "source/lib/core-net/sorted-usec-list.c",
    "source/lib/core-net/state.c",
    "source/lib/core-net/vhost.c",
    "source/lib/core-net/wsi-timeout.c",
    "source/lib/core-net/wsi.c",

    # Core
    "source/lib/core/alloc.c",
    "source/lib/core/buflist.c",
    "source/lib/core/context.c",
    "source/lib/core/libwebsockets.c",
    "source/lib/core/logs.c",
    "source/lib/core/lws_dll2.c",
    "source/lib/core/lws_map.c",
    "source/lib/core/vfs.c",

    "source/lib/event-libs/poll/poll.c",
    "source/lib/misc/base64-decode.c",
    "source/lib/misc/cache-ttl/file.c",
    "source/lib/misc/cache-ttl/heap.c",
    "source/lib/misc/cache-ttl/lws-cache-ttl.c",
    "source/lib/misc/dir.c",
    "source/lib/misc/lejp.c",
    "source/lib/misc/lws-ring.c",
    "source/lib/misc/lwsac/cached-file.c",
    "source/lib/misc/lwsac/lwsac.c",
    "source/lib/misc/prng.c",
    "source/lib/misc/sha-1.c",

    # Platform-specific files (Linux/Unix)
    "source/lib/plat/unix/unix-caps.c",
    "source/lib/plat/unix/unix-fds.c",
    "source/lib/plat/unix/unix-file.c",
    "source/lib/plat/unix/unix-init.c",
    "source/lib/plat/unix/unix-misc.c",
    "source/lib/plat/unix/unix-pipe.c",
    "source/lib/plat/unix/unix-service.c",
    "source/lib/plat/unix/unix-sockets.c",
    
    "source/lib/roles/h1/ops-h1.c",
    "source/lib/roles/h2/hpack.c",
    "source/lib/roles/h2/http2.c",
    "source/lib/roles/h2/ops-h2.c",
    "source/lib/roles/http/client/client-http.c",
    "source/lib/roles/http/cookie.c",
    "source/lib/roles/http/date.c",
    "source/lib/roles/http/header.c",
    "source/lib/roles/http/parsers.c",
    "source/lib/roles/http/server/lejp-conf.c",
    "source/lib/roles/http/server/lws-spa.c",
    "source/lib/roles/http/server/server.c",
    "source/lib/roles/listen/ops-listen.c",
    "source/lib/roles/pipe/ops-pipe.c",
    "source/lib/roles/raw-file/ops-raw-file.c",
    "source/lib/roles/raw-skt/ops-raw-skt.c",
    "source/lib/roles/ws/client-parser-ws.c",
    "source/lib/roles/ws/client-ws.c",
    "source/lib/roles/ws/ops-ws.c",
    "source/lib/roles/ws/server-ws.c",
    "source/lib/system/smd/smd.c",
    "source/lib/system/system.c",

    # TLS Backend (CRITICAL: BoringSSL integration)
    "source/lib/tls/openssl/openssl-client.c",
    "source/lib/tls/openssl/openssl-server.c",
    "source/lib/tls/openssl/openssl-session.c",
    "source/lib/tls/openssl/openssl-ssl.c",
    "source/lib/tls/openssl/openssl-tls.c",
    "source/lib/tls/openssl/openssl-x509.c",
    "source/lib/tls/tls-client.c",
    "source/lib/tls/tls-network.c",
    "source/lib/tls/tls-server.c",
    "source/lib/tls/tls-sessions.c",
    "source/lib/tls/tls.c"
  ]

  include_dirs = [
    "source/lib/core",
    "source/lib/core-net",
    "source/lib/event-libs",
    "source/lib/abstract",
    "source/lib/tls",
    "source/lib/roles",
    "source/lib/event-libs/libuv",
    "source/lib/event-libs/poll",
    "source/lib/event-libs/libevent",
    "source/lib/event-libs/glib",
    "source/lib/event-libs/libev",
    "source/lib/jose/jwe",
    "source/lib/jose/jws",
    "source/lib/jose",
    "source/lib/misc",
    "source/lib/roles/http",
    "source/lib/roles/http/compression",
    "source/lib/roles/h1",
    "source/lib/roles/h2",
    "source/lib/roles/ws",
    "source/lib/roles/cgi",
    "source/lib/roles/dbus",
    "source/lib/roles/raw-proxy",
    "source/lib/abstract",
    "source/lib/system/async-dns",
    "source/lib/system/smd",
    "source/lib/system/metrics",
    "source/lib/roles/mqtt",
    "source/lib/plat/unix",
    "source/lib"
  ]

  # Apply the public configuration (include_dirs) for consumers
  public_configs = [ ":libwebsockets_public_config" ]

  # Define dependencies on other Chromium targets
  deps = [
    # CRITICAL: LWS depends on BoringSSL for TLS features
    "//third_party/boringssl:boringssl",
    "//base", # LWS might implicitly rely on some basic system features Chromium's base provides
  ]

  # If you need to specify a language (e.g., C99) for LWS sources explicitly:
  cflags_c = [
                "-Wno-unused-parameter",
                "-Wno-missing-field-initializers",
                "-Wno-unreachable-code",
                "-Wno-unused-function", 
                "-Wno-unused-variable",
                "-Wno-shadow",
                "-Wno-unreachable-code-return",
                "-Wno-implicit-fallthrough"
            ]
}
